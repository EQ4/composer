Player View
===========

    images = [
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAgCAYAAACYTcH3AAABeElEQVRYR+2XMU4DMRBF7RtEoky7J8iSLiIlDR1HoIMT5AQ5QdLlCOloUoLSQTjBtpRI3AD4K0006/V4xxuvguS4WmntmTffM2Pb/vwN80+GvcAIO9GpjLX2pE2MyYIWDDmHEXxP3lYnwXxMnwzZgqEQXAMGzu8/N2Y7fjgaSAnDbfsiVMMgwphBQXBlksDAYFVVMSymKIp6i/OAQbRdCtGcZMpgP5DEGCS1C8HBfJAcBnaQL2RXqihvafOFEgwMwyGGTy0OowGBHW/T4yUegglltAtD7SK0RuzA1Px4icaUk7tO04mDx0HKDqwJRA0jNb2uDk19JimMxphvTt4wh+tHU76vveLloczh6tmUX3di+sxHr+bl+6bxfxBlAELDBdrNFvWv2/2yBToIDLxIypwFpk95D6bM2WH6ALhrNOeSeGpLAO6Fnc8L/dMG1Plu0jrMD8Z9UUrPDa4MV1ObL6qcISfcge/Wpp3X66ZHi6S3thuxdl4I5hcgNeqwgiRFxgAAAABJRU5ErkJggg=="
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABDklEQVRYhe1WwRHCMAxzuT7YoZOwR3foTOzAHkzCDjy4M58UmtbBUupePuiZOJbOdmyLNEZX8UaD/NAPVUTkdb5sLvrnvVoMaqwWsYUkBhZxiiSvQR9BvkpBqIBaYhUwDZ6RW3iP2zU7H8YJ8fv145B3icz6ehn5ME4bMQiQIswIQRIVu19sAKUg2elMnsL8EVUCkg4vAp3lYCa1BLFgW6gWii4TtDh3/cOdELSjfSNGS3JWsGvP/AImXaGz4FAwAmrqwAU6C+aQhoughxExHaE6aJ4C9Bsu7cwdoTCaXf9MCn6O5vV5EuTuBSF9wBKFrnHN+wCagmL49wKOwFGbMSyA3XxR+yPHMeP/j3Z4A6F+XR8/HV/0AAAAAElFTkSuQmCC"
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAA9klEQVRYR+1VQQ7DIAwrt/W2/f+R2227scIIDYgsMepUTQqntoLY2E4alpNXOBl/cQKugCvwlwpEYXZMXQY5lIHj5driP+/5PYRaCqlpHkRxWx/g9TYkQB8LETMJy0YZnFCLCjMk7ATo5h1YVYR9R1TQCMTG8x6crtzbkjLxeuRoaD87bQNGgAhuhI4jkMInyc8VmMyBrkCffkMGWFtq9VWP9A7gJv/aguKrmCse2KMykIcfIdIwSm0mPTN2qvymNikFdyvK2B0RQLyvQ0vr0xGBb2eQIYQokK2o/wOBAQqOEmjyIHEwKlq3mYKCFkX2OwFXwBV4A45aZSF7iJhTAAAAAElFTkSuQmCC"
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACBElEQVRYhd2WPXLCMBCFnzKZAZEZOg5AiuQKSUlpHyVcIamSOh0cBcqUyRWSAh+AjgJDmk1hVkiyfm2qvBkPRpb1Pu+u1hZEROgoIQQAgIiM8xxd9zGnTaHO94shZDFrxjMgOgGwIQBguoLuR5syCyIZgENsaLpS1zgNjbFjrm/dlBoQQmA7GOPm/RcAMJofjCe0AXIikAUAAJPjDkC42PRoxZZPToEyPhVevZSQT7W6zv/14mSYEEQUgAtuND+cF56uIIsS9VKqebKYoV5KY04DHC7KYAr03BsAmgEAoCrb996uk/pDEgDQpID3umHuAfAB2boK3UREmBx3Kv8+1euPKIBPQQCGiJmN5ofOEFEAFhciAKP49C3XBSKpD7ARQ3Ab5m1otOaTZDE73+vJfxKAqwXvF0OjB/ggOGJBCwoIAG0HY3XOB22K1jzXkSJnI+Kn5i2o9rLeB/wPFJ2jSwHYodabiB3aJqcO4yrvVWwAAGj1cHvsbN42YON+3wOnDsfbzNV6Qwb2iyhFzj7AFe7a1+J27V0s19wA0HPuVFUCVdlOSUaBuuR9HTPQfmFGwf4a6qtWIwpGAWh9isXmxOSMwMPrXWvs6+VHLZzzyRVT8suIjYUQTsCLAPgW/3z+VuP2byxlWQA+Pb7dO8cvUYxGEXZ9mj4gZiu+4PZKVVYR/kuAP2cpj5wHwkFvAAAAAElFTkSuQmCC"
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAv0lEQVRYR+2V2w2AIAxFYQcncBt3cABHcgB3cBsncAcMJCSV8LiFEDSpX35U7/G0VK0GX3pwvhIAMSAGxEC1AXMtxi4xPZ/V73DP127CoQA+3MO3WKgyMBQgDG+1kDWQCkPnBmlNsQUxiHW71bFPjoPeUzAkHD4FIUQJAA2HAWwhhcgBcMJZACFEbA644f8CQE8E10LxFHjVnwPwX9q6FSEDNCSlGKmJDi6y1dA/H1r3WlgIQM8aqAUCIAZ6GngAn2heIYHghYoAAAAASUVORK5CYII="
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABNUlEQVRYhe2VO07DQBRFTxwiW9AlYiFUNKkSJR0SK6BBYg9ZAXuIRMMKkNKBcOXGFQuJ7C4okWWGIrYzE5x4XmK6OZKL+fjdq/s8HnA4HI7zUMVzMp5QzBgnISRh/VrbBtRyFuiFVSEM/DGhDpg6ywDeZF0J6eL7JurWjtGx2KOWswBvspZVBgajZg3JN2AULoofnbNBbGAw2sadhDvBujlbrFsAiNvQVgs618//03+rDRpVEnA4jZ+PgMKwVW2JASjOtm5ER0vKuq7UgGGkjXrSU2D8+6fRnLvPW11c7e9p4kIiPo3m+JsXuv0ebzcRAN1+z1i/vHolTzMW41hhkYj1XVCKA+Rpxv3XkPfhE3maAds0SnGgTKYxCUkCbPzH3WAFELEYx9XU9+oBfP2NGIfD4WjiF2OVci5ammFnAAAAAElFTkSuQmCC"
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABbklEQVRYhe2WsU7EMAyGfQjpmI7lXoo3YGNL3iBCYr6lb+BubDyUw8J4LGxsvsnBSZM2TTkVif5S1TZp48+OnWTHzAwr6mZN4xvABjAJYK0Fa+16AAAAiHhViCKAtRYQcfTn34jQaAS898GANiSGT69vg77Z4oKMMdk2Ywyf94foyn1bqyxAOuB5f4ieS8ZbQKoBxHsNkTOe3mcDGGOYiKKBAID5/WEAJP0pyByIYhL2fQ8AAPj8EbV/3t1HyYiIoVokGZ1z7UmoPdDd6byn3k29V0dAvPHeAxGF9uP3V3RPvdRrhvd+WQSYmYkoeJ6T5Ip8J//o/KlRBCA1TkTBsIRdw6UA2vDcUgwAMqDMsTasAXSbhmhdjAY58PL0WJx3ka6Epdox/xxK0zU9txnpPUDDTm1cReXCohejXHnJtST0otscVHoGSCPjnIOu69o8rolAKSLicWvG5xTlwJhq8qNF1QDX0t8+FW8A/wLgAriKs4bOMx0mAAAAAElFTkSuQmCC"
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABC0lEQVRYCe1UOw7CMAwtiJPkDsxsnACJgRmJSzBxCRRmBiROwMbMoUoNdeRYtXGiSoDkLvX3+eXFbdP44wq4Aq6AK+AKuAJfVmBinb9ZzlusPd8eWZ+Wwx7pPZMSWvx+PSUyUBdj1MrV3FTN/kKSytvbcPoWVOiVePm0roR3kQL87ukgLUfruF28A92pMwz0F6ttFrc6JgWG5IWBtUMpORMB2jC2nX3PQ+D09HjP/fKl8k6JjzipmBmmRkoihMAg3u7heDFh8eaiK5CGA+h+t85+TnyQ5JsIoPQAAiQoEe5Lg6S4iQAOlkAwXqOCmQAOGfv9vwRg62s3n6poUgDvli4fBQEbc1jL85L/BC72R3R+G8VAAAAAAElFTkSuQmCC"
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACUAAAAyCAYAAADbTRIgAAABeUlEQVRYR+2W7RHCMAiGW8fwYx0X0Bl0JndwAV3HcwytTTRepBAgSa3n0X96NDy8vJC2zQ8+7URMXZ+XzD0FVHc9HprFdu/0QPOXQiUrRrrggdwz3+yatvXpBwwlUHHFZNUA7APKv4SAFUOBqlNwb6DwzuhQQZFX5YPOdZ3rNP5AtYqUSiXSTHUtqJ6HrlwDhLUwR6lsoNBarKBYrWKoVKJYMRc3W1+a22npJw6CVYPiEmFQ7r/7eTU+FJUIeotTNaj1tfZJzF8NSpJMGsNBJedduw6whZqaQNg+D8MlxaYH8487h4rF/IUpJd4/qUShIM7UiWvpeUU/xdFtaIkCEkXh2uh/50NF1wPZ7lGgoEEpNakvA2rqmHPeSvkWIoeggxDHadseKxzOAT78gJKuExin9iOViNtTWsAqYLWhsiaYuBurtC+yhm6tGJTWkGC7W/tYAW36WIleAaaUKQUUKL7/zFPmKfOU1AOmlCkVKWDLU2oHU+ovlHoAHAgiQqD2oO0AAAAASUVORK5CYII="
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABV0lEQVRYR92WzQ3CMAyFW07AAkiwFELsgBDzcGAHluLAgQUQJ4oc1VXaxvZLDRTBBVDs+MvzT1IWI3/KkeMXPwdQGYpYwNn+3Q2r6/mUZFhtd1C2DP/eAZIA3WCpTdlGWyNiXq/tTQDyYRnJuFGENpBOR07xuqBWMn1aTlvBWX/kxMvNOpiXk0X40nInLQYV4mA5CpAvCiECaHJD1VhD1CqISmQDaN3QhUZUyAKg4PfjtCfAbH9pcp6C0GphEMD88GiB0P/qeQtF91EAbjepBlJ1Q2l4mwJo8cV2XwGQWtRThGEiIq3IwVMQ1unNKWVBaMMJCQ4BDMl75GNd3+qchlIgAXoVcAX33gXu4KzKkC7oBe/e89qLJ3588G8LwnySeQE4HdI0/H2AeP5bg0l6J2odYSrgnAPB/b8BrLdibhfAlxCaGmsiqq9iNAhgJ94J5mUBbO4yeQEnn9gh67HjMQAAAABJRU5ErkJggg=="
    ].map (src) ->
      img = new Image
      img.src = src

      img

    module.exports = (I, self) ->
      Canvas = require "touch-canvas"

      canvas = Canvas()

      canvas.on "touch", (p) ->
        self.activeTool()(self, p)

      handleResize =  ->
        canvas.width(window.innerWidth)
        canvas.height(window.innerHeight)

      handleResize()
      window.addEventListener "resize", handleResize, false

      document.body.appendChild canvas.element()

      drawNote = (canvas, note) ->
        [time, note, instrument] = note

        {width, height} = img = images[instrument]

        x = time * canvas.width() - width/2
        y = (24 - note) * canvas.height() / 25 - height/2

        canvas.drawImage img, x, y

      paint = ->
        canvas.fill "white"

        [1..25].forEach (i) ->
          canvas.drawRect
            x: 0
            y: i * canvas.height()/25
            width: canvas.width()
            height: 1
            color: "rgba(0, 0, 0, 0.25)"

        # Draw notes
        self.notes().forEach (note) ->
          drawNote(canvas, note)

        # Draw player cursor
        canvas.drawRect
          x: self.playTime() * canvas.width()
          y: 0
          width: 1
          height: canvas.height()
          color: "#F0F"

        requestAnimationFrame(paint)
  
      paint()
      
      self.setCursor = ->
        if img = images[self.activeInstrument()]
          {width, height, src:url} = img
  
          x = -width/2
          y = -height/2
  
          $(canvas.element()).css
            cursor: "url(#{url}) #{x} #{y}, default"
